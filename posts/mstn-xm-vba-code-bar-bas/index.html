<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="MicroStation XM 断面处理程序源码-模块-BarCode" /><meta name="author" content="QinDong" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="MicroStation XM VBA编写的工程测量断面处理程序，与目前的MicroStation CE不兼容，需稍作调整方可在CE中运行。代码中大部分代码和功能、过程与目前高版一样，可以参考使用。" /><meta property="og:description" content="MicroStation XM VBA编写的工程测量断面处理程序，与目前的MicroStation CE不兼容，需稍作调整方可在CE中运行。代码中大部分代码和功能、过程与目前高版一样，可以参考使用。" /><link rel="canonical" href="https://www.cehui.ren/posts/mstn-xm-vba-code-bar-bas/" /><meta property="og:url" content="https://www.cehui.ren/posts/mstn-xm-vba-code-bar-bas/" /><meta property="og:site_name" content="测量老覃’s blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2008-03-12T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="MicroStation XM 断面处理程序源码-模块-BarCode" /><meta name="twitter:site" content="@qd_xyz" /><meta name="twitter:creator" content="@qd_xyz" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"QinDong","url":"https://www.cehui.ren/about/"},"dateModified":"2008-03-12T00:00:00+08:00","datePublished":"2008-03-12T00:00:00+08:00","description":"MicroStation XM VBA编写的工程测量断面处理程序，与目前的MicroStation CE不兼容，需稍作调整方可在CE中运行。代码中大部分代码和功能、过程与目前高版一样，可以参考使用。","headline":"MicroStation XM 断面处理程序源码-模块-BarCode","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.cehui.ren/posts/mstn-xm-vba-code-bar-bas/"},"url":"https://www.cehui.ren/posts/mstn-xm-vba-code-bar-bas/"}</script><title>MicroStation XM 断面处理程序源码-模块-BarCode | 测量老覃's blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="测量老覃's blog"><meta name="application-name" content="测量老覃's blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/img/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">测量老覃's blog</a></div><div class="site-subtitle font-italic">www.cehui.ren</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/qin-dong" aria-label="stack-overflow" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/qd_xyz" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['qd.xyz','139.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" target="_blank" rel="noopener"> <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>MicroStation XM 断面处理程序源码-模块-BarCode</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4 pb-5"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>MicroStation XM 断面处理程序源码-模块-BarCode</h1><div class="post-meta text-muted"> <span> 发表于 <em class="" data-ts="1205251200" data-df="YYYY-MM-DD" data-toggle="tooltip" data-placement="bottom"> 2008-03-12 </em> </span><div class="d-flex justify-content-between"> <span> 作者 <em> <a href="https://www.cehui.ren/about/">QinDong</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2758 字"> <em>15 分钟</em>阅读</span></div></div></div><div class="post-content"><p>MicroStation XM VBA编写的工程测量断面处理程序，与目前的MicroStation CE不兼容，需稍作调整方可在CE中运行。代码中大部分代码和功能、过程与目前高版一样，可以参考使用。</p><blockquote><p>模块名：BarCode.bas</p></blockquote><div class="language-vb highlighter-rouge"><div class="code-header"> <span data-label-text="Visual Basic"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
</pre><td class="rouge-code"><pre><span class="n">Attribute</span> <span class="n">VB_Name</span> <span class="o">=</span> <span class="s">"BarCode"</span>
<span class="k">Dim</span> <span class="nv">miniX</span> <span class="ow">As</span> <span class="kt">Double</span>
<span class="k">Dim</span> <span class="nv">miniY</span> <span class="ow">As</span> <span class="kt">Double</span>
<span class="k">Dim</span> <span class="nv">maxX</span> <span class="ow">As</span> <span class="kt">Double</span>
<span class="k">Dim</span> <span class="nv">maxY</span> <span class="ow">As</span> <span class="kt">Double</span>

<span class="k">Sub</span> <span class="nf">DelSingleBar</span><span class="p">()</span>
<span class="k">Dim</span> <span class="nv">dbModel</span> <span class="ow">As</span> <span class="n">ModelReference</span>
<span class="k">Dim</span> <span class="nv">dbEle</span> <span class="ow">As</span> <span class="n">Element</span>
<span class="k">Dim</span> <span class="nv">dbEe</span> <span class="ow">As</span> <span class="n">ElementEnumerator</span>
<span class="k">Set</span> <span class="n">dbModel</span> <span class="o">=</span> <span class="n">ActiveModelReference</span>
  <span class="k">Set</span> <span class="n">dbEe</span> <span class="o">=</span> <span class="n">dbModel</span><span class="p">.</span><span class="n">GraphicalElementCache</span><span class="p">.</span><span class="n">Scan</span>
  <span class="k">Do</span> <span class="k">While</span> <span class="n">dbEe</span><span class="p">.</span><span class="n">MoveNext</span>
  <span class="k">Set</span> <span class="n">dbEle</span> <span class="o">=</span> <span class="n">dbEe</span><span class="p">.</span><span class="n">Current</span>
   <span class="n">dbEle</span><span class="p">.</span><span class="n">IsLocked</span> <span class="o">=</span> <span class="k">False</span>
   <span class="k">If</span> <span class="n">dbEle</span><span class="p">.</span><span class="n">HasXData</span><span class="p">(</span><span class="s">"(C)SurMap.com BarCreator"</span><span class="p">)</span> <span class="k">Then</span> <span class="n">dbModel</span><span class="p">.</span><span class="n">RemoveElement</span> <span class="n">dbEle</span>
  <span class="k">Loop</span>

<span class="k">End</span> <span class="k">Sub</span>

<span class="k">Sub</span> <span class="nf">DelAllBar</span><span class="p">()</span>
<span class="k">Dim</span> <span class="nv">dbModel</span> <span class="ow">As</span> <span class="n">ModelReference</span>
<span class="k">Dim</span> <span class="nv">dbEle</span> <span class="ow">As</span> <span class="n">Element</span>
<span class="k">Dim</span> <span class="nv">dbEe</span> <span class="ow">As</span> <span class="n">ElementEnumerator</span>
<span class="k">For</span> <span class="k">Each</span> <span class="n">dbModel</span> <span class="ow">In</span> <span class="n">ActiveDesignFile</span><span class="p">.</span><span class="n">Models</span>
  <span class="k">Set</span> <span class="n">dbEe</span> <span class="o">=</span> <span class="n">dbModel</span><span class="p">.</span><span class="n">GraphicalElementCache</span><span class="p">.</span><span class="n">Scan</span>
  <span class="k">Do</span> <span class="k">While</span> <span class="n">dbEe</span><span class="p">.</span><span class="n">MoveNext</span>
  <span class="k">Set</span> <span class="n">dbEle</span> <span class="o">=</span> <span class="n">dbEe</span><span class="p">.</span><span class="n">Current</span>
   <span class="n">dbEle</span><span class="p">.</span><span class="n">IsLocked</span> <span class="o">=</span> <span class="k">False</span>
   <span class="k">If</span> <span class="n">dbEle</span><span class="p">.</span><span class="n">HasXData</span><span class="p">(</span><span class="s">"(C)SurMap.com BarCreator"</span><span class="p">)</span> <span class="k">Then</span> <span class="n">dbModel</span><span class="p">.</span><span class="n">RemoveElement</span> <span class="n">dbEle</span>
  <span class="k">Loop</span>
<span class="k">Next</span>

<span class="k">End</span> <span class="k">Sub</span>


<span class="k">Sub</span> <span class="nf">CrtSingleBar</span><span class="p">()</span>
<span class="k">Dim</span> <span class="nv">cmModel</span> <span class="ow">As</span> <span class="n">ModelReference</span>
<span class="k">Dim</span> <span class="nv">cmScale</span> <span class="ow">As</span> <span class="kt">String</span>
<span class="k">Dim</span> <span class="nv">cmSide</span> <span class="ow">As</span> <span class="kt">Integer</span>
<span class="k">Dim</span> <span class="nv">cmGrid</span> <span class="ow">As</span> <span class="kt">Boolean</span>

<span class="k">Dim</span> <span class="nv">cmPaperWidth</span> <span class="ow">As</span> <span class="kt">Integer</span>
<span class="k">Dim</span> <span class="nv">cmPaperHeight</span> <span class="ow">As</span> <span class="kt">Integer</span>
<span class="k">Dim</span> <span class="nv">cmFullGrid</span> <span class="ow">As</span> <span class="kt">Boolean</span>

<span class="n">cmGrid</span> <span class="o">=</span> <span class="n">LoadGridPara</span><span class="p">(</span><span class="n">ActiveDesignFile</span><span class="p">.</span><span class="n">DefaultModelReference</span><span class="p">,</span> <span class="s">"(C)SurMap.com Parameter"</span><span class="p">)</span>
<span class="n">cmScale</span> <span class="o">=</span> <span class="n">LoadScalePara</span><span class="p">(</span><span class="n">ActiveDesignFile</span><span class="p">.</span><span class="n">DefaultModelReference</span><span class="p">,</span> <span class="s">"(C)SurMap.com Parameter"</span><span class="p">)</span>
<span class="n">cmSide</span> <span class="o">=</span> <span class="n">LoadSidePara</span><span class="p">(</span><span class="n">ActiveDesignFile</span><span class="p">.</span><span class="n">DefaultModelReference</span><span class="p">,</span> <span class="s">"(C)SurMap.com Parameter"</span><span class="p">)</span>

<span class="k">If</span> <span class="n">cmScale</span> <span class="o">=</span> <span class="s">""</span> <span class="k">Then</span> <span class="n">cmScale</span> <span class="o">=</span> <span class="s">"500"</span>
<span class="k">If</span> <span class="n">cmSide</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">Then</span> <span class="n">cmSide</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

<span class="n">gAppName</span> <span class="o">=</span> <span class="s">"(C)SurMap.com BarCreator"</span>
<span class="c1">'For Each cmModel In ActiveDesignFile.Models</span>
<span class="k">Set</span> <span class="n">cmModel</span> <span class="o">=</span> <span class="n">ActiveModelReference</span>
<span class="c1">'If cmModel.Name &lt;&gt; "Default" Then</span>
<span class="n">ActiveDesignFile</span><span class="p">.</span><span class="n">Views</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">DisplaysFill</span> <span class="o">=</span> <span class="k">True</span>
<span class="n">ViewArea</span> <span class="n">cmModel</span>

<span class="c1">'调整图纸</span>
<span class="n">cmFullGrid</span> <span class="o">=</span> <span class="n">LoadFullGridPara</span><span class="p">(</span><span class="n">ActiveDesignFile</span><span class="p">.</span><span class="n">DefaultModelReference</span><span class="p">,</span> <span class="s">"(C)SurMap.com Parameter"</span><span class="p">)</span>
<span class="k">If</span> <span class="n">cmGrid</span> <span class="ow">And</span> <span class="n">cmFullGrid</span> <span class="k">Then</span>
<span class="n">DeterminePaper</span> <span class="n">ActiveDesignFile</span><span class="p">.</span><span class="n">DefaultModelReference</span><span class="p">,</span> <span class="s">"(C)SurMap.com Parameter"</span><span class="p">,</span> <span class="n">cmPaperWidth</span><span class="p">,</span> <span class="n">cmPaperHeight</span>
<span class="n">cmPaperWidth</span> <span class="o">=</span> <span class="n">cmPaperWidth</span> <span class="o">-</span> <span class="mi">60</span>
<span class="n">cmPaperHeight</span> <span class="o">=</span> <span class="n">cmPaperHeight</span> <span class="o">-</span> <span class="mi">50</span>
    <span class="k">If</span> <span class="n">cmPaperWidth</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">Val</span><span class="p">(</span><span class="n">cmScale</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">maxX</span> <span class="o">-</span> <span class="n">miniX</span><span class="p">)</span> <span class="ow">And</span> <span class="n">cmPaperHeight</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">Val</span><span class="p">(</span><span class="n">cmScale</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">maxY</span> <span class="o">-</span> <span class="n">miniY</span><span class="p">)</span> <span class="k">Then</span>
        <span class="n">miniX</span> <span class="o">=</span> <span class="n">miniX</span> <span class="o">-</span> <span class="p">(</span><span class="n">cmPaperWidth</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">Val</span><span class="p">(</span><span class="n">cmScale</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="n">maxX</span> <span class="o">-</span> <span class="n">miniX</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">miniY</span> <span class="o">=</span> <span class="n">miniY</span> <span class="o">-</span> <span class="p">(</span><span class="n">cmPaperHeight</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">Val</span><span class="p">(</span><span class="n">cmScale</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="n">maxY</span> <span class="o">-</span> <span class="n">miniY</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">maxX</span> <span class="o">=</span> <span class="n">miniX</span> <span class="o">+</span> <span class="n">cmPaperWidth</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">Val</span><span class="p">(</span><span class="n">cmScale</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="n">maxY</span> <span class="o">=</span> <span class="n">miniY</span> <span class="o">+</span> <span class="n">cmPaperHeight</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">Val</span><span class="p">(</span><span class="n">cmScale</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>
    <span class="k">End</span> <span class="k">If</span>
<span class="k">End</span> <span class="k">If</span>
<span class="c1">'调整图纸</span>

<span class="n">crtBar</span> <span class="n">cmModel</span><span class="p">,</span> <span class="n">miniX</span><span class="p">,</span> <span class="n">miniY</span><span class="p">,</span> <span class="n">maxX</span> <span class="o">-</span> <span class="n">miniX</span><span class="p">,</span> <span class="n">maxY</span> <span class="o">-</span> <span class="n">miniY</span><span class="p">,</span> <span class="n">Val</span><span class="p">(</span><span class="n">cmScale</span><span class="p">),</span> <span class="n">cmSide</span><span class="p">,</span> <span class="n">cmGrid</span><span class="p">,</span> <span class="s">"标尺_"</span> <span class="o">&amp;</span> <span class="n">cmScale</span><span class="p">,</span> <span class="s">"宋体"</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span>
<span class="c1">'crtBar cmModel, -135, 253, 200, 200, 500, 1, False, "标尺", "宋体", 2, 2</span>
<span class="c1">'End If</span>
<span class="c1">'Next</span>
<span class="k">End</span> <span class="k">Sub</span>


<span class="k">Sub</span> <span class="nf">CrtAllBar</span><span class="p">()</span>
<span class="k">Dim</span> <span class="nv">cmModel</span> <span class="ow">As</span> <span class="n">ModelReference</span>
<span class="k">Dim</span> <span class="nv">cmScale</span> <span class="ow">As</span> <span class="kt">String</span>
<span class="k">Dim</span> <span class="nv">cmSide</span> <span class="ow">As</span> <span class="kt">Integer</span>
<span class="k">Dim</span> <span class="nv">cmGrid</span> <span class="ow">As</span> <span class="kt">Boolean</span>
<span class="k">Dim</span> <span class="nv">cmPaperWidth</span> <span class="ow">As</span> <span class="kt">Integer</span>
<span class="k">Dim</span> <span class="nv">cmPaperHeight</span> <span class="ow">As</span> <span class="kt">Integer</span>
<span class="k">Dim</span> <span class="nv">cmFullGrid</span> <span class="ow">As</span> <span class="kt">Boolean</span>



<span class="n">cmGrid</span> <span class="o">=</span> <span class="n">LoadGridPara</span><span class="p">(</span><span class="n">ActiveDesignFile</span><span class="p">.</span><span class="n">DefaultModelReference</span><span class="p">,</span> <span class="s">"(C)SurMap.com Parameter"</span><span class="p">)</span>
<span class="n">cmScale</span> <span class="o">=</span> <span class="n">LoadScalePara</span><span class="p">(</span><span class="n">ActiveDesignFile</span><span class="p">.</span><span class="n">DefaultModelReference</span><span class="p">,</span> <span class="s">"(C)SurMap.com Parameter"</span><span class="p">)</span>
<span class="n">cmSide</span> <span class="o">=</span> <span class="n">LoadSidePara</span><span class="p">(</span><span class="n">ActiveDesignFile</span><span class="p">.</span><span class="n">DefaultModelReference</span><span class="p">,</span> <span class="s">"(C)SurMap.com Parameter"</span><span class="p">)</span>

<span class="k">If</span> <span class="n">cmScale</span> <span class="o">=</span> <span class="s">""</span> <span class="k">Then</span> <span class="n">cmScale</span> <span class="o">=</span> <span class="s">"500"</span>
<span class="k">If</span> <span class="n">cmSide</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">Then</span> <span class="n">cmSide</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

<span class="n">gAppName</span> <span class="o">=</span> <span class="s">"(C)SurMap.com BarCreator"</span>
<span class="k">For</span> <span class="k">Each</span> <span class="n">cmModel</span> <span class="ow">In</span> <span class="n">ActiveDesignFile</span><span class="p">.</span><span class="n">Models</span>
<span class="k">If</span> <span class="n">cmModel</span><span class="p">.</span><span class="n">Name</span> <span class="o">&lt;&gt;</span> <span class="s">"Default"</span> <span class="ow">And</span> <span class="n">getModelXdata</span><span class="p">(</span><span class="n">cmModel</span><span class="p">,</span> <span class="s">"surmap_dx"</span><span class="p">,</span> <span class="n">msdXDatumTypeString</span><span class="p">)</span> <span class="o">&lt;&gt;</span> <span class="s">"dxmodel"</span> <span class="k">Then</span>
<span class="n">ViewArea</span> <span class="n">cmModel</span>
<span class="c1">'调整图纸</span>
<span class="n">cmFullGrid</span> <span class="o">=</span> <span class="n">LoadFullGridPara</span><span class="p">(</span><span class="n">ActiveDesignFile</span><span class="p">.</span><span class="n">DefaultModelReference</span><span class="p">,</span> <span class="s">"(C)SurMap.com Parameter"</span><span class="p">)</span>
<span class="k">If</span> <span class="n">cmGrid</span> <span class="ow">And</span> <span class="n">cmFullGrid</span> <span class="k">Then</span>
<span class="n">DeterminePaper</span> <span class="n">ActiveDesignFile</span><span class="p">.</span><span class="n">DefaultModelReference</span><span class="p">,</span> <span class="s">"(C)SurMap.com Parameter"</span><span class="p">,</span> <span class="n">cmPaperWidth</span><span class="p">,</span> <span class="n">cmPaperHeight</span>
<span class="n">cmPaperWidth</span> <span class="o">=</span> <span class="n">cmPaperWidth</span> <span class="o">-</span> <span class="mi">60</span>
<span class="n">cmPaperHeight</span> <span class="o">=</span> <span class="n">cmPaperHeight</span> <span class="o">-</span> <span class="mi">50</span>
    <span class="k">If</span> <span class="n">cmPaperWidth</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">Val</span><span class="p">(</span><span class="n">cmScale</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">maxX</span> <span class="o">-</span> <span class="n">miniX</span><span class="p">)</span> <span class="ow">And</span> <span class="n">cmPaperHeight</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">Val</span><span class="p">(</span><span class="n">cmScale</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">maxY</span> <span class="o">-</span> <span class="n">miniY</span><span class="p">)</span> <span class="k">Then</span>
        <span class="n">miniX</span> <span class="o">=</span> <span class="n">miniX</span> <span class="o">-</span> <span class="p">(</span><span class="n">cmPaperWidth</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">Val</span><span class="p">(</span><span class="n">cmScale</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="n">maxX</span> <span class="o">-</span> <span class="n">miniX</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">miniY</span> <span class="o">=</span> <span class="n">miniY</span> <span class="o">-</span> <span class="p">(</span><span class="n">cmPaperHeight</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">Val</span><span class="p">(</span><span class="n">cmScale</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="n">maxY</span> <span class="o">-</span> <span class="n">miniY</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">maxX</span> <span class="o">=</span> <span class="n">miniX</span> <span class="o">+</span> <span class="n">cmPaperWidth</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">Val</span><span class="p">(</span><span class="n">cmScale</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="n">maxY</span> <span class="o">=</span> <span class="n">miniY</span> <span class="o">+</span> <span class="n">cmPaperHeight</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">Val</span><span class="p">(</span><span class="n">cmScale</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>
    <span class="k">End</span> <span class="k">If</span>
<span class="k">End</span> <span class="k">If</span>
<span class="c1">'调整图纸</span>
<span class="n">crtBar</span> <span class="n">cmModel</span><span class="p">,</span> <span class="n">miniX</span><span class="p">,</span> <span class="n">miniY</span><span class="p">,</span> <span class="n">maxX</span> <span class="o">-</span> <span class="n">miniX</span><span class="p">,</span> <span class="n">maxY</span> <span class="o">-</span> <span class="n">miniY</span><span class="p">,</span> <span class="n">Val</span><span class="p">(</span><span class="n">cmScale</span><span class="p">),</span> <span class="n">cmSide</span><span class="p">,</span> <span class="n">cmGrid</span><span class="p">,</span> <span class="s">"标尺_"</span> <span class="o">&amp;</span> <span class="n">cmScale</span><span class="p">,</span> <span class="s">"宋体"</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span>
<span class="c1">'crtBar cmModel, -135, 253, 200, 200, 500, 1, False, "标尺", "宋体", 2, 2</span>
<span class="k">End</span> <span class="k">If</span>
<span class="k">Next</span>
<span class="k">End</span> <span class="k">Sub</span>

<span class="c1">'创建标尺参数：左、右、宽、高、比例（整数分母）、左右侧（L or R）、网格（真或否）,字体样式名,字体名,字宽(毫米),字高(毫米),</span>

<span class="k">Sub</span> <span class="nf">crtBar</span><span class="p">(</span><span class="n">bModel</span> <span class="ow">As</span> <span class="n">ModelReference</span><span class="p">,</span> <span class="n">bLeft</span> <span class="ow">As</span> <span class="kt">Double</span><span class="p">,</span> <span class="n">bBottom</span> <span class="ow">As</span> <span class="kt">Double</span><span class="p">,</span> <span class="n">bWidth</span> <span class="ow">As</span> <span class="kt">Double</span><span class="p">,</span> <span class="n">bHeight</span> <span class="ow">As</span> <span class="kt">Double</span><span class="p">,</span> <span class="n">bScale</span> <span class="ow">As</span> <span class="kt">Integer</span><span class="p">,</span> <span class="n">bSide</span> <span class="ow">As</span> <span class="kt">Integer</span><span class="p">,</span> <span class="n">bGrid</span> <span class="ow">As</span> <span class="kt">Boolean</span><span class="p">,</span> <span class="n">bTextStyleName</span> <span class="ow">As</span> <span class="kt">String</span><span class="p">,</span> <span class="n">bFontName</span> <span class="ow">As</span> <span class="kt">String</span><span class="p">,</span> <span class="n">bFontWidth_mm</span> <span class="ow">As</span> <span class="k">Single</span><span class="p">,</span> <span class="n">bFontHeight_mm</span> <span class="ow">As</span> <span class="k">Single</span><span class="p">)</span>
<span class="k">Dim</span> <span class="nv">cbLevel</span> <span class="ow">As</span> <span class="n">Level</span> <span class="c1">'绘标尺的层名</span>
<span class="k">Dim</span> <span class="nv">cbStep</span> <span class="ow">As</span> <span class="kt">Integer</span> <span class="c1">'步长</span>
<span class="k">Dim</span> <span class="nv">cbWeight</span> <span class="ow">As</span> <span class="k">Single</span> <span class="c1">'竖标尺的宽度</span>
<span class="k">Dim</span> <span class="nv">cbLeft</span> <span class="ow">As</span> <span class="kt">Integer</span>
<span class="k">Dim</span> <span class="nv">cbBottom</span> <span class="ow">As</span> <span class="kt">Integer</span>
<span class="k">Dim</span> <span class="nv">cbWidth</span> <span class="ow">As</span> <span class="kt">Integer</span> <span class="c1">'宽度</span>
<span class="k">Dim</span> <span class="nv">cbHeight</span> <span class="ow">As</span> <span class="kt">Integer</span>
<span class="c1">'循环次数</span>
<span class="k">Dim</span> <span class="nv">cbVtime</span> <span class="ow">As</span> <span class="kt">Integer</span>
<span class="k">Dim</span> <span class="nv">cbHtime</span> <span class="ow">As</span> <span class="kt">Integer</span>

<span class="k">Dim</span> <span class="nv">cbI</span> <span class="ow">As</span> <span class="kt">Integer</span>

<span class="k">Dim</span> <span class="nv">cbVpoints</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="ow">As</span> <span class="n">Point3d</span>
<span class="k">Dim</span> <span class="nv">cbModel</span> <span class="ow">As</span> <span class="n">ModelReference</span>
<span class="k">Dim</span> <span class="nv">cbShp</span> <span class="ow">As</span> <span class="n">ShapeElement</span>
<span class="k">Dim</span> <span class="nv">cbText</span> <span class="ow">As</span> <span class="n">TextElement</span>

<span class="k">Dim</span> <span class="nv">cbLineEle</span> <span class="ow">As</span> <span class="n">LineElement</span> <span class="c1">'水平线</span>
<span class="k">Dim</span> <span class="nv">cbLineStart</span> <span class="ow">As</span> <span class="n">Point3d</span>
<span class="k">Dim</span> <span class="nv">cbLineEnd</span> <span class="ow">As</span> <span class="n">Point3d</span>

<span class="k">Dim</span> <span class="nv">cbFontWidth</span> <span class="ow">As</span> <span class="k">Single</span>
<span class="k">Dim</span> <span class="nv">cbFontHeight</span> <span class="ow">As</span> <span class="k">Single</span>
<span class="c1">'临时变量</span>
<span class="k">Dim</span> <span class="nv">cTmpLeft</span> <span class="ow">As</span> <span class="kt">Double</span>
<span class="k">Dim</span> <span class="nv">cTmpBottom</span> <span class="ow">As</span> <span class="kt">Double</span>
<span class="k">Dim</span> <span class="nv">cTmpRight</span> <span class="ow">As</span> <span class="kt">Double</span>
<span class="k">Dim</span> <span class="nv">cTmpUp</span> <span class="ow">As</span> <span class="kt">Double</span>
<span class="k">Dim</span> <span class="nv">cTmpVtag</span> <span class="ow">As</span> <span class="n">Point3d</span> <span class="c1">'高程注记位置</span>
<span class="k">Dim</span> <span class="nv">cTmpHtag</span> <span class="ow">As</span> <span class="n">Point3d</span> <span class="c1">'水平距离注记</span>

<span class="c1">'断面桩号等信息</span>
<span class="k">Dim</span> <span class="nv">ProInfo</span> <span class="ow">As</span> <span class="kt">String</span>
<span class="k">Dim</span> <span class="nv">ProInfoPosition</span> <span class="ow">As</span> <span class="n">Point3d</span>

<span class="c1">'网格线</span>
<span class="k">Dim</span> <span class="nv">cTmpGridHStart</span> <span class="ow">As</span> <span class="n">Point3d</span> <span class="c1">'水平</span>
<span class="k">Dim</span> <span class="nv">cTmpGridHEnd</span> <span class="ow">As</span> <span class="n">Point3d</span>
<span class="k">Dim</span> <span class="nv">cTmpGridHLine</span> <span class="ow">As</span> <span class="n">LineElement</span>
<span class="k">Dim</span> <span class="nv">cTmpGridVStart</span> <span class="ow">As</span> <span class="n">Point3d</span> <span class="c1">'竖直</span>
<span class="k">Dim</span> <span class="nv">cTmpGridVEnd</span> <span class="ow">As</span> <span class="n">Point3d</span>
<span class="k">Dim</span> <span class="nv">cTmpGridVLine</span> <span class="ow">As</span> <span class="n">LineElement</span>


<span class="k">Set</span> <span class="n">cbLevel</span> <span class="o">=</span> <span class="n">FindLevel</span><span class="p">(</span><span class="s">"断面标尺"</span><span class="p">)</span>

<span class="n">cbStep</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="n">bScale</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">cbWeight</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">cbStep</span>

<span class="n">cbLeft</span> <span class="o">=</span> <span class="p">(</span><span class="n">Int</span><span class="p">(</span><span class="n">bLeft</span> <span class="o">/</span> <span class="n">cbStep</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">cbStep</span>
<span class="n">cbWidth</span> <span class="o">=</span> <span class="p">(</span><span class="n">Round</span><span class="p">(</span><span class="n">bWidth</span> <span class="o">/</span> <span class="n">cbStep</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">cbStep</span>

<span class="n">cbBottom</span> <span class="o">=</span> <span class="p">(</span><span class="n">Int</span><span class="p">(</span><span class="n">bBottom</span> <span class="o">/</span> <span class="n">cbStep</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">cbStep</span>
<span class="n">cbHeight</span> <span class="o">=</span> <span class="p">(</span><span class="n">Round</span><span class="p">(</span><span class="n">bHeight</span> <span class="o">/</span> <span class="n">cbStep</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">cbStep</span>

<span class="n">cbVtime</span> <span class="o">=</span> <span class="n">cbHeight</span> <span class="o">/</span> <span class="n">cbStep</span>
<span class="n">cbHtime</span> <span class="o">=</span> <span class="n">cbWidth</span> <span class="o">/</span> <span class="n">cbStep</span>

<span class="c1">'字高,将以mm为单位的字高换算为绘图单位</span>
<span class="n">cbFontWidth</span> <span class="o">=</span> <span class="n">bFontWidth_mm</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">cbStep</span>
<span class="n">cbFontHeight</span> <span class="o">=</span> <span class="n">bFontHeight_mm</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">cbStep</span>


<span class="k">Set</span> <span class="n">cbModel</span> <span class="o">=</span> <span class="n">bModel</span>
<span class="k">For</span> <span class="n">cbI</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">To</span> <span class="n">cbVtime</span>

<span class="k">If</span> <span class="n">bSide</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="k">Then</span>
<span class="n">cTmpLeft</span> <span class="o">=</span> <span class="n">cbLeft</span>
<span class="n">cTmpRight</span> <span class="o">=</span> <span class="n">cTmpLeft</span> <span class="o">+</span> <span class="n">cbWeight</span>
<span class="k">Else</span>
<span class="n">cTmpLeft</span> <span class="o">=</span> <span class="n">cbLeft</span> <span class="o">+</span> <span class="n">cbWidth</span> <span class="o">-</span> <span class="n">cbWeight</span>
<span class="n">cTmpRight</span> <span class="o">=</span> <span class="n">cTmpLeft</span> <span class="o">+</span> <span class="n">cbWeight</span>
<span class="k">End</span> <span class="k">If</span>
<span class="n">cTmpBottom</span> <span class="o">=</span> <span class="p">(</span><span class="n">cbI</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">cbStep</span> <span class="o">+</span> <span class="n">cbBottom</span>
<span class="n">cTmpUp</span> <span class="o">=</span> <span class="n">cTmpBottom</span> <span class="o">+</span> <span class="n">cbStep</span>


<span class="n">cbVpoints</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">X</span> <span class="o">=</span> <span class="n">cTmpLeft</span>
<span class="n">cbVpoints</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">Y</span> <span class="o">=</span> <span class="n">cTmpBottom</span>

<span class="n">cbVpoints</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">X</span> <span class="o">=</span> <span class="n">cTmpRight</span>
<span class="n">cbVpoints</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">Y</span> <span class="o">=</span> <span class="n">cTmpBottom</span>

<span class="n">cbVpoints</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">X</span> <span class="o">=</span> <span class="n">cTmpRight</span>
<span class="n">cbVpoints</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">Y</span> <span class="o">=</span> <span class="n">cTmpUp</span>

<span class="n">cbVpoints</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="n">X</span> <span class="o">=</span> <span class="n">cTmpLeft</span>
<span class="n">cbVpoints</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="n">Y</span> <span class="o">=</span> <span class="n">cTmpUp</span>

<span class="c1">'=======================</span>
<span class="c1">'竖标尺</span>
<span class="k">If</span> <span class="n">cbI</span> <span class="ow">Mod</span> <span class="mi">2</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">Then</span>
<span class="k">Set</span> <span class="n">cbShp</span> <span class="o">=</span> <span class="n">CreateShapeElement1</span><span class="p">(</span><span class="k">Nothing</span><span class="p">,</span> <span class="n">cbVpoints</span><span class="p">,</span> <span class="n">msdFillModeFilled</span><span class="p">)</span>
<span class="k">Else</span>
<span class="k">Set</span> <span class="n">cbShp</span> <span class="o">=</span> <span class="n">CreateShapeElement1</span><span class="p">(</span><span class="k">Nothing</span><span class="p">,</span> <span class="n">cbVpoints</span><span class="p">,</span> <span class="n">msdFillModeNotFilled</span><span class="p">)</span>
<span class="c1">'竖标尺</span>
<span class="c1">'=======================</span>

<span class="c1">'***********************</span>

<span class="c1">'=======================</span>
<span class="c1">'调整高程注记与竖标尺的间距在此</span>
<span class="c1">'竖标尺注记</span>
<span class="n">cTmpVtag</span> <span class="o">=</span> <span class="n">cbVpoints</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="k">If</span> <span class="n">bSide</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="k">Then</span>
<span class="n">cTmpVtag</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">cTmpVtag</span><span class="p">.</span><span class="n">X</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">cbStep</span> <span class="c1">'与竖标尺的间距,0.1为0.1公分,cbStep分图上一公分所对应的绘图长度</span>
<span class="k">Else</span>
<span class="n">cTmpVtag</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">cTmpVtag</span><span class="p">.</span><span class="n">X</span> <span class="o">-</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">cbStep</span> <span class="o">-</span> <span class="n">cbFontWidth</span> <span class="o">*</span> <span class="mi">3</span> <span class="c1">'与竖标尺的间距,0.1为0.1公分,cbStep分图上一公分所对应的绘图长度</span>
<span class="k">End</span> <span class="k">If</span>
<span class="n">cTmpVtag</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">cTmpVtag</span><span class="p">.</span><span class="n">Y</span> <span class="o">+</span> <span class="n">cbFontHeight</span>
<span class="k">Set</span> <span class="n">cbText</span> <span class="o">=</span> <span class="n">CreateTextElement1</span><span class="p">(</span><span class="k">Nothing</span><span class="p">,</span> <span class="n">cTmpUp</span><span class="p">,</span> <span class="n">cTmpVtag</span><span class="p">,</span> <span class="n">Matrix3dIdentity</span><span class="p">)</span>
<span class="k">End</span> <span class="k">If</span>
<span class="c1">'调整高程注记与竖标尺的间距在此</span>
<span class="c1">'竖标尺注记</span>
<span class="c1">'=======================</span>

    <span class="n">cbShp</span><span class="p">.</span><span class="n">LineStyle</span> <span class="o">=</span> <span class="n">ActiveDesignFile</span><span class="p">.</span><span class="n">LineStyles</span><span class="p">(</span><span class="s">"0"</span><span class="p">)</span>
    <span class="n">cbShp</span><span class="p">.</span><span class="n">Level</span> <span class="o">=</span> <span class="n">cbLevel</span>
    <span class="n">cbShp</span><span class="p">.</span><span class="n">FillColor</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">SetElementXdata</span> <span class="n">cbShp</span><span class="p">,</span> <span class="n">gAppName</span><span class="p">,</span> <span class="n">msdXDatumTypeString</span><span class="p">,</span> <span class="s">"Type:Bar"</span>
    <span class="c1">'锁定并禁止捕捉</span>
    <span class="n">cbShp</span><span class="p">.</span><span class="n">IsLocked</span> <span class="o">=</span> <span class="k">True</span>
    <span class="n">cbShp</span><span class="p">.</span><span class="n">IsSnappable</span> <span class="o">=</span> <span class="k">False</span>
    <span class="n">cbModel</span><span class="p">.</span><span class="n">AddElement</span> <span class="n">cbShp</span>
    <span class="n">cbShp</span><span class="p">.</span><span class="n">Rewrite</span>
    <span class="n">cbShp</span><span class="p">.</span><span class="n">Redraw</span>



    <span class="k">Set</span> <span class="n">cbText</span><span class="p">.</span><span class="n">TextStyle</span> <span class="o">=</span> <span class="n">adTextStyle</span><span class="p">(</span><span class="n">bTextStyleName</span><span class="p">,</span> <span class="n">bFontName</span><span class="p">,</span> <span class="n">cbFontWidth</span><span class="p">,</span> <span class="n">cbFontHeight</span><span class="p">)</span>
    <span class="n">cbText</span><span class="p">.</span><span class="n">Level</span> <span class="o">=</span> <span class="n">cbLevel</span>
    <span class="n">cbText</span><span class="p">.</span><span class="n">Color</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">SetElementXdata</span> <span class="n">cbText</span><span class="p">,</span> <span class="n">gAppName</span><span class="p">,</span> <span class="n">msdXDatumTypeString</span><span class="p">,</span> <span class="s">"Type:Bar"</span>
    <span class="c1">'锁定并禁止捕捉</span>
<span class="c1">'    cbText.IsLocked = True</span>
<span class="c1">'    cbText.IsSnappable = False</span>
    <span class="n">cbModel</span><span class="p">.</span><span class="n">AddElement</span> <span class="n">cbText</span>
    <span class="n">cbText</span><span class="p">.</span><span class="n">Rewrite</span>
    <span class="n">cbText</span><span class="p">.</span><span class="n">Redraw</span>



    <span class="c1">'网络线:水平线######################</span>
    <span class="k">If</span> <span class="n">bGrid</span> <span class="k">Then</span>
    <span class="k">If</span> <span class="n">bSide</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">Then</span>
    <span class="c1">'标尺在左侧时</span>
    <span class="n">cTmpGridHStart</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">cTmpRight</span>
    <span class="n">cTmpGridHEnd</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">cTmpRight</span> <span class="o">+</span> <span class="n">cbWidth</span> <span class="o">-</span> <span class="n">cbWeight</span>
    <span class="k">Else</span>
    <span class="c1">'标尺在右侧时</span>
    <span class="n">cTmpGridHStart</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">cbLeft</span>
    <span class="n">cTmpGridHEnd</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">cbLeft</span> <span class="o">+</span> <span class="n">cbWidth</span> <span class="o">-</span> <span class="n">cbWeight</span>
    <span class="k">End</span> <span class="k">If</span>
    
    <span class="n">cTmpGridHStart</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">cTmpUp</span>
    <span class="n">cTmpGridHEnd</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">cTmpUp</span>
    <span class="k">Set</span> <span class="n">cTmpGridHLine</span> <span class="o">=</span> <span class="n">CreateLineElement2</span><span class="p">(</span><span class="k">Nothing</span><span class="p">,</span> <span class="n">cTmpGridHStart</span><span class="p">,</span> <span class="n">cTmpGridHEnd</span><span class="p">)</span>
    <span class="n">cTmpGridHLine</span><span class="p">.</span><span class="n">LineStyle</span> <span class="o">=</span> <span class="n">ActiveDesignFile</span><span class="p">.</span><span class="n">LineStyles</span><span class="p">(</span><span class="s">"0"</span><span class="p">)</span>
    <span class="n">cTmpGridHLine</span><span class="p">.</span><span class="n">Level</span> <span class="o">=</span> <span class="n">cbLevel</span>
    <span class="n">cTmpGridHLine</span><span class="p">.</span><span class="n">Color</span> <span class="o">=</span> <span class="mi">64</span>
    
    <span class="n">SetElementXdata</span> <span class="n">cTmpGridHLine</span><span class="p">,</span> <span class="n">gAppName</span><span class="p">,</span> <span class="n">msdXDatumTypeString</span><span class="p">,</span> <span class="s">"Type:Bar"</span>
    <span class="c1">'锁定并禁止捕捉</span>
    <span class="n">cTmpGridHLine</span><span class="p">.</span><span class="n">IsLocked</span> <span class="o">=</span> <span class="k">True</span>
    <span class="n">cTmpGridHLine</span><span class="p">.</span><span class="n">IsSnappable</span> <span class="o">=</span> <span class="k">False</span>
    
    <span class="n">cbModel</span><span class="p">.</span><span class="n">AddElement</span> <span class="n">cTmpGridHLine</span>
    <span class="n">cTmpGridHLine</span><span class="p">.</span><span class="n">Redraw</span>
    <span class="n">cTmpGridHLine</span><span class="p">.</span><span class="n">Rewrite</span>
    <span class="k">End</span> <span class="k">If</span>
    <span class="c1">'网络线:水平线######################</span>

<span class="k">Next</span>

    <span class="c1">'**********************</span>
    <span class="c1">'水平标尺</span>
    <span class="k">If</span> <span class="n">bSide</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="k">Then</span>
        <span class="c1">'竖标尺在左边</span>
        <span class="n">cbLineStart</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">cbLeft</span> <span class="o">+</span> <span class="n">cbWeight</span>
        <span class="n">cbLineStart</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">cbBottom</span>
        
        <span class="n">cbLineEnd</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">cbLeft</span> <span class="o">+</span> <span class="n">cbWidth</span>
        <span class="n">cbLineEnd</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">cbBottom</span>
    <span class="k">Else</span>
        <span class="c1">'竖标尺在右边</span>
        <span class="n">cbLineStart</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">cbLeft</span>
        <span class="n">cbLineStart</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">cbBottom</span>
        
        <span class="n">cbLineEnd</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">cbLineStart</span><span class="p">.</span><span class="n">X</span> <span class="o">+</span> <span class="n">cbWidth</span> <span class="o">-</span> <span class="n">cbWeight</span>
        <span class="n">cbLineEnd</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">cbBottom</span>
    <span class="k">End</span> <span class="k">If</span>
    <span class="k">Set</span> <span class="n">cbLineEle</span> <span class="o">=</span> <span class="n">CreateLineElement2</span><span class="p">(</span><span class="k">Nothing</span><span class="p">,</span> <span class="n">cbLineStart</span><span class="p">,</span> <span class="n">cbLineEnd</span><span class="p">)</span>
    <span class="n">SetElementXdata</span> <span class="n">cbLineEle</span><span class="p">,</span> <span class="n">gAppName</span><span class="p">,</span> <span class="n">msdXDatumTypeString</span><span class="p">,</span> <span class="s">"Type:Bar"</span>
    <span class="n">cbLineEle</span><span class="p">.</span><span class="n">LineStyle</span> <span class="o">=</span> <span class="n">ActiveDesignFile</span><span class="p">.</span><span class="n">LineStyles</span><span class="p">(</span><span class="s">"0"</span><span class="p">)</span>
    <span class="n">cbLineEle</span><span class="p">.</span><span class="n">Level</span> <span class="o">=</span> <span class="n">cbLevel</span>
    <span class="c1">'锁定并禁止捕捉</span>
    <span class="n">cbLineEle</span><span class="p">.</span><span class="n">IsLocked</span> <span class="o">=</span> <span class="k">True</span>
    <span class="n">cbLineEle</span><span class="p">.</span><span class="n">IsSnappable</span> <span class="o">=</span> <span class="k">False</span>
    <span class="n">cbModel</span><span class="p">.</span><span class="n">AddElement</span> <span class="n">cbLineEle</span>
    <span class="n">cbLineEle</span><span class="p">.</span><span class="n">Rewrite</span>
    <span class="n">cbLineEle</span><span class="p">.</span><span class="n">Redraw</span>
    <span class="c1">'水平标尺</span>
    <span class="c1">'**********************</span>

<span class="k">For</span> <span class="n">cbI</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">To</span> <span class="n">cbHtime</span>

<span class="k">If</span> <span class="n">bSide</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="k">Then</span>
<span class="c1">'左</span>
<span class="n">cbLineStart</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">cbLeft</span> <span class="o">+</span> <span class="n">cbI</span> <span class="o">*</span> <span class="n">cbStep</span>
<span class="n">cbLineEnd</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">cbLeft</span> <span class="o">+</span> <span class="n">cbI</span> <span class="o">*</span> <span class="n">cbStep</span>
<span class="k">Else</span>
<span class="c1">'右</span>
<span class="n">cbLineStart</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">cbLeft</span> <span class="o">+</span> <span class="p">(</span><span class="n">cbI</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">cbStep</span>
<span class="n">cbLineEnd</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">cbLeft</span> <span class="o">+</span> <span class="p">(</span><span class="n">cbI</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">cbStep</span>
<span class="k">End</span> <span class="k">If</span>
<span class="n">cbLineStart</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">cbBottom</span>
<span class="n">cbLineEnd</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">cbBottom</span> <span class="o">+</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">cbStep</span>

<span class="k">Set</span> <span class="n">cbLineEle</span> <span class="o">=</span> <span class="n">CreateLineElement2</span><span class="p">(</span><span class="k">Nothing</span><span class="p">,</span> <span class="n">cbLineStart</span><span class="p">,</span> <span class="n">cbLineEnd</span><span class="p">)</span>
<span class="n">cbModel</span><span class="p">.</span><span class="n">AddElement</span> <span class="n">cbLineEle</span>
<span class="n">SetElementXdata</span> <span class="n">cbLineEle</span><span class="p">,</span> <span class="n">gAppName</span><span class="p">,</span> <span class="n">msdXDatumTypeString</span><span class="p">,</span> <span class="s">"Type:Bar"</span>
<span class="c1">'锁定并取消捕捉</span>
<span class="n">cbLineEle</span><span class="p">.</span><span class="n">Level</span> <span class="o">=</span> <span class="n">cbLevel</span>
<span class="n">cbLineEle</span><span class="p">.</span><span class="n">LineStyle</span> <span class="o">=</span> <span class="n">ActiveDesignFile</span><span class="p">.</span><span class="n">LineStyles</span><span class="p">(</span><span class="s">"0"</span><span class="p">)</span>
<span class="n">cbLineEle</span><span class="p">.</span><span class="n">IsLocked</span> <span class="o">=</span> <span class="k">True</span>
<span class="n">cbLineEle</span><span class="p">.</span><span class="n">IsSnappable</span> <span class="o">=</span> <span class="k">False</span>
<span class="n">cbLineEle</span><span class="p">.</span><span class="n">Rewrite</span>
<span class="n">cbLineEle</span><span class="p">.</span><span class="n">Redraw</span>

<span class="c1">'水平距离注记位置</span>
<span class="n">cTmpHtag</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">cbLineStart</span><span class="p">.</span><span class="n">X</span> <span class="o">-</span> <span class="n">cbFontWidth</span>
<span class="n">cTmpHtag</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">cbLineEnd</span><span class="p">.</span><span class="n">Y</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">cbStep</span> <span class="o">+</span> <span class="n">cbFontHeight</span>

<span class="k">Set</span> <span class="n">cbText</span> <span class="o">=</span> <span class="n">CreateTextElement1</span><span class="p">(</span><span class="k">Nothing</span><span class="p">,</span> <span class="n">cbLineStart</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">cTmpHtag</span><span class="p">,</span> <span class="n">Matrix3dIdentity</span><span class="p">)</span>
<span class="k">Set</span> <span class="n">cbText</span><span class="p">.</span><span class="n">TextStyle</span> <span class="o">=</span> <span class="n">adTextStyle</span><span class="p">(</span><span class="n">bTextStyleName</span><span class="p">,</span> <span class="n">bFontName</span><span class="p">,</span> <span class="n">cbFontWidth</span><span class="p">,</span> <span class="n">cbFontHeight</span><span class="p">)</span>
<span class="n">SetElementXdata</span> <span class="n">cbText</span><span class="p">,</span> <span class="n">gAppName</span><span class="p">,</span> <span class="n">msdXDatumTypeString</span><span class="p">,</span> <span class="s">"Type:Bar"</span>
<span class="n">cbText</span><span class="p">.</span><span class="n">Level</span> <span class="o">=</span> <span class="n">cbLevel</span>
<span class="n">cbText</span><span class="p">.</span><span class="n">Color</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1">'锁定并取消捕捉</span>
<span class="c1">'cbText.IsLocked = True</span>
<span class="c1">'cbText.IsSnappable = False</span>
<span class="n">cbModel</span><span class="p">.</span><span class="n">AddElement</span> <span class="n">cbText</span>
<span class="n">cbText</span><span class="p">.</span><span class="n">Rewrite</span>
<span class="n">cbText</span><span class="p">.</span><span class="n">Redraw</span>

<span class="c1">'网络线:竖直线######################</span>
<span class="k">If</span> <span class="n">bGrid</span> <span class="k">Then</span>
<span class="n">cTmpGridVStart</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">cbLineStart</span><span class="p">.</span><span class="n">X</span>
<span class="n">cTmpGridVStart</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">cTmpHtag</span><span class="p">.</span><span class="n">Y</span>
<span class="n">cTmpGridVEnd</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">cbLineStart</span><span class="p">.</span><span class="n">X</span>
<span class="n">cTmpGridVEnd</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">cTmpHtag</span><span class="p">.</span><span class="n">Y</span> <span class="o">+</span> <span class="n">cbHeight</span> <span class="o">-</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="n">cbStep</span> <span class="o">-</span> <span class="n">cbFontHeight</span>
<span class="k">Set</span> <span class="n">cTmpGridVLine</span> <span class="o">=</span> <span class="n">CreateLineElement2</span><span class="p">(</span><span class="k">Nothing</span><span class="p">,</span> <span class="n">cTmpGridVStart</span><span class="p">,</span> <span class="n">cTmpGridVEnd</span><span class="p">)</span>
<span class="n">cTmpGridVLine</span><span class="p">.</span><span class="n">Level</span> <span class="o">=</span> <span class="n">cbLevel</span>
<span class="n">cTmpGridVLine</span><span class="p">.</span><span class="n">Color</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">SetElementXdata</span> <span class="n">cTmpGridVLine</span><span class="p">,</span> <span class="n">gAppName</span><span class="p">,</span> <span class="n">msdXDatumTypeString</span><span class="p">,</span> <span class="s">"Type:Bar"</span>
<span class="c1">'锁定并取消捕捉</span>
<span class="n">cTmpGridVLine</span><span class="p">.</span><span class="n">LineStyle</span> <span class="o">=</span> <span class="n">ActiveDesignFile</span><span class="p">.</span><span class="n">LineStyles</span><span class="p">(</span><span class="s">"0"</span><span class="p">)</span>
<span class="n">cTmpGridVLine</span><span class="p">.</span><span class="n">IsLocked</span> <span class="o">=</span> <span class="k">True</span>
<span class="n">cTmpGridVLine</span><span class="p">.</span><span class="n">IsSnappable</span> <span class="o">=</span> <span class="k">False</span>
<span class="n">cbModel</span><span class="p">.</span><span class="n">AddElement</span> <span class="n">cTmpGridVLine</span>
<span class="n">cTmpGridVLine</span><span class="p">.</span><span class="n">Rewrite</span>
<span class="n">cTmpGridVLine</span><span class="p">.</span><span class="n">Redraw</span>
<span class="k">End</span> <span class="k">If</span>
<span class="c1">'网络线:竖直线######################</span>

<span class="k">Next</span>

<span class="n">ProInfo</span> <span class="o">=</span> <span class="s">"桩号:"</span> <span class="o">&amp;</span> <span class="n">cbModel</span><span class="p">.</span><span class="n">Name</span> <span class="o">&amp;</span> <span class="s">"  比例:1:"</span> <span class="o">&amp;</span> <span class="n">cbStep</span> <span class="o">*</span> <span class="mi">100</span>
<span class="n">ProInfoPosition</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">cbLeft</span> <span class="o">+</span> <span class="p">(</span><span class="n">cbWidth</span> <span class="o">-</span> <span class="n">Len</span><span class="p">(</span><span class="n">ProInfo</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="n">cbStep</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
<span class="n">ProInfoPosition</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">cbBottom</span> <span class="o">+</span> <span class="n">cbHeight</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">cbStep</span>                       <span class="c1">'桩号放在上面</span>
<span class="c1">'ProInfoPosition.Y = cbBottom - 0.1 * cbStep                                 '桩号放在下面</span>
<span class="k">Set</span> <span class="n">cbText</span> <span class="o">=</span> <span class="n">CreateTextElement1</span><span class="p">(</span><span class="k">Nothing</span><span class="p">,</span> <span class="n">ProInfo</span><span class="p">,</span> <span class="n">ProInfoPosition</span><span class="p">,</span> <span class="n">Matrix3dIdentity</span><span class="p">)</span>
<span class="n">cbModel</span><span class="p">.</span><span class="n">AddElement</span> <span class="n">cbText</span>
<span class="k">Set</span> <span class="n">cbText</span><span class="p">.</span><span class="n">TextStyle</span> <span class="o">=</span> <span class="n">adTextStyle</span><span class="p">(</span><span class="n">bTextStyleName</span><span class="p">,</span> <span class="n">bFontName</span><span class="p">,</span> <span class="n">cbFontWidth</span><span class="p">,</span> <span class="n">cbFontHeight</span><span class="p">)</span>
<span class="n">SetElementXdata</span> <span class="n">cbText</span><span class="p">,</span> <span class="n">gAppName</span><span class="p">,</span> <span class="n">msdXDatumTypeString</span><span class="p">,</span> <span class="s">"Type:Bar"</span>
<span class="n">cbText</span><span class="p">.</span><span class="n">TextStyle</span><span class="p">.</span><span class="n">Height</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="n">cbStep</span>
<span class="n">cbText</span><span class="p">.</span><span class="n">TextStyle</span><span class="p">.</span><span class="n">Width</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="n">cbStep</span>
<span class="n">cbText</span><span class="p">.</span><span class="n">Color</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">cbText</span><span class="p">.</span><span class="n">Level</span> <span class="o">=</span> <span class="n">cbLevel</span>
<span class="n">cbText</span><span class="p">.</span><span class="n">Rewrite</span>
<span class="n">cbText</span><span class="p">.</span><span class="n">Redraw</span>


<span class="k">End</span> <span class="k">Sub</span>

<span class="c1">'Sub TestTextStyle()</span>
<span class="c1">'adTextStyle "覃", "宋体", 10, 10</span>
<span class="c1">'End Sub</span>

<span class="c1">'查找并设置文本样式格式</span>
<span class="c1">'参数:样式名、字体名、高度、宽度</span>
<span class="c1">'若样式不存在则创建，若存在则设置</span>
<span class="c1">'Function adTextStyle(txtStyleName As String, txtFontName As String, txtStyleHeight As Single, txtStyleWidth As Single) As TextStyle</span>
<span class="c1">'Dim aTextStyle As TextStyle</span>
<span class="c1">'Set aTextStyle = ActiveDesignFile.TextStyles.Find(txtStyleName)</span>
<span class="c1">'If aTextStyle Is Nothing Then</span>
<span class="c1">'Set aTextStyle = ActiveDesignFile.TextStyles.Add(Nothing, txtStyleName)</span>
<span class="c1">'aTextStyle.Height = txtStyleHeight</span>
<span class="c1">'aTextStyle.Width = txtStyleWidth</span>
<span class="c1">'aTextStyle.Font = FindFontByName(txtFontName)</span>
<span class="c1">''Else</span>
<span class="c1">''aTextStyle.Height = txtStyleHeight</span>
<span class="c1">''aTextStyle.Width = txtStyleWidth</span>
<span class="c1">''aTextStyle.Font = FindFontByName(txtFontName)</span>
<span class="c1">'End If</span>
<span class="c1">'Set adTextStyle = aTextStyle</span>
<span class="c1">'End Function</span>


<span class="k">Function</span> <span class="nf">FindFontByName</span><span class="p">(</span><span class="n">fFontName</span> <span class="ow">As</span> <span class="kt">String</span><span class="p">)</span> <span class="ow">As</span> <span class="n">Font</span>
<span class="k">Dim</span> <span class="nv">fFonts</span> <span class="ow">As</span> <span class="n">Fonts</span>
<span class="k">Dim</span> <span class="nv">fFont</span> <span class="ow">As</span> <span class="n">Font</span>
<span class="k">Set</span> <span class="n">FindFontByName</span> <span class="o">=</span> <span class="k">Nothing</span>
<span class="k">Set</span> <span class="n">fFonts</span> <span class="o">=</span> <span class="n">ActiveDesignFile</span><span class="p">.</span><span class="n">Fonts</span>
<span class="k">For</span> <span class="k">Each</span> <span class="n">fFont</span> <span class="ow">In</span> <span class="n">fFonts</span>
<span class="k">If</span> <span class="n">fFont</span><span class="p">.</span><span class="n">Name</span> <span class="o">=</span> <span class="n">fFontName</span> <span class="k">Then</span> <span class="k">Set</span> <span class="n">FindFontByName</span> <span class="o">=</span> <span class="n">fFont</span>
<span class="k">Next</span>
<span class="k">End</span> <span class="k">Function</span>

<span class="c1">'********************查找绘图范围(只处理直线对象)**************</span>
<span class="k">Sub</span> <span class="nf">ViewArea</span><span class="p">(</span><span class="n">vaModel</span> <span class="ow">As</span> <span class="n">ModelReference</span><span class="p">)</span>
<span class="k">Dim</span> <span class="nv">m</span> <span class="ow">As</span> <span class="n">ModelReference</span>
<span class="k">Dim</span> <span class="nv">Ee</span> <span class="ow">As</span> <span class="n">ElementEnumerator</span>
<span class="k">Dim</span> <span class="nv">Ele</span> <span class="ow">As</span> <span class="n">LineElement</span>
<span class="n">miniX</span> <span class="o">=</span> <span class="mi">1</span><span class="n">E</span><span class="o">+</span><span class="mi">15</span>
<span class="n">miniY</span> <span class="o">=</span> <span class="mi">1</span><span class="n">E</span><span class="o">+</span><span class="mi">15</span>
<span class="n">maxX</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="n">E</span><span class="o">+</span><span class="mi">15</span>
<span class="n">maxY</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="n">E</span><span class="o">+</span><span class="mi">15</span>


<span class="k">Set</span> <span class="n">m</span> <span class="o">=</span> <span class="n">vaModel</span>
<span class="k">Set</span> <span class="n">Ee</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">GraphicalElementCache</span><span class="p">.</span><span class="n">Scan</span>

    <span class="k">Do</span> <span class="k">While</span> <span class="n">Ee</span><span class="p">.</span><span class="n">MoveNext</span>
        <span class="k">If</span> <span class="n">Ee</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">Type</span> <span class="o">=</span> <span class="n">msdElementTypeLine</span> <span class="ow">Or</span> <span class="n">Ee</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">Type</span> <span class="o">=</span> <span class="n">msdElementTypeLineString</span> <span class="k">Then</span>
            <span class="k">If</span> <span class="n">Ee</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">Level</span><span class="p">.</span><span class="n">IsEffectivelyDisplayedInView</span><span class="p">(</span><span class="n">ActiveDesignFile</span><span class="p">.</span><span class="n">Views</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="k">Then</span>
            <span class="k">Set</span> <span class="n">Ele</span> <span class="o">=</span> <span class="n">Ee</span><span class="p">.</span><span class="n">Current</span>
            <span class="n">MiniMax</span> <span class="n">Ele</span>
            <span class="k">End</span> <span class="k">If</span>
        <span class="k">End</span> <span class="k">If</span>
    <span class="k">Loop</span>
<span class="c1">'ShowMessage miniX &amp; " " &amp; miniY &amp; " " &amp; maxX &amp; " " &amp; maxY</span>
<span class="k">End</span> <span class="k">Sub</span>

<span class="k">Sub</span> <span class="nf">MiniMax</span><span class="p">(</span><span class="n">Ele</span> <span class="ow">As</span> <span class="n">LineElement</span><span class="p">)</span>
<span class="k">Dim</span> <span class="nv">tEle</span> <span class="ow">As</span> <span class="n">LineElement</span>
<span class="k">Dim</span> <span class="nv">vPoints</span><span class="p">()</span> <span class="ow">As</span> <span class="n">Point3d</span>
<span class="k">Dim</span> <span class="nv">i</span> <span class="ow">As</span> <span class="kt">Long</span>
<span class="n">vPoints</span> <span class="o">=</span> <span class="n">Ele</span><span class="p">.</span><span class="n">GetVertices</span>
<span class="k">For</span> <span class="n">i</span> <span class="o">=</span> <span class="n">LBound</span><span class="p">(</span><span class="n">vPoints</span><span class="p">)</span> <span class="k">To</span> <span class="n">UBound</span><span class="p">(</span><span class="n">vPoints</span><span class="p">)</span>
<span class="k">If</span> <span class="n">vPoints</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">X</span> <span class="o">&lt;</span> <span class="n">miniX</span> <span class="k">Then</span> <span class="n">miniX</span> <span class="o">=</span> <span class="n">vPoints</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">X</span>
<span class="k">If</span> <span class="n">vPoints</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">Y</span> <span class="o">&lt;</span> <span class="n">miniY</span> <span class="k">Then</span> <span class="n">miniY</span> <span class="o">=</span> <span class="n">vPoints</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">Y</span>

<span class="k">If</span> <span class="n">vPoints</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">X</span> <span class="o">&gt;</span> <span class="n">maxX</span> <span class="k">Then</span> <span class="n">maxX</span> <span class="o">=</span> <span class="n">vPoints</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">X</span>
<span class="k">If</span> <span class="n">vPoints</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">Y</span> <span class="o">&gt;</span> <span class="n">maxY</span> <span class="k">Then</span> <span class="n">maxY</span> <span class="o">=</span> <span class="n">vPoints</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">Y</span>

<span class="k">Next</span>
<span class="k">End</span> <span class="k">Sub</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%E7%BC%96%E7%A8%8B%E5%BC%80%E5%8F%91/'>编程开发</a>, <a href='/categories/vba-microstation/'>VBA-MicroStation</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/microstation/" class="post-tag no-text-decoration" >MicroStation</a> <a href="/tags/vba/" class="post-tag no-text-decoration" >VBA</a> <a href="/tags/xm/" class="post-tag no-text-decoration" >XM</a> <a href="/tags/%E4%BB%A3%E7%A0%81/" class="post-tag no-text-decoration" >代码</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=MicroStation+XM+%E6%96%AD%E9%9D%A2%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F%E6%BA%90%E7%A0%81-%E6%A8%A1%E5%9D%97-BarCode+-+%E6%B5%8B%E9%87%8F%E8%80%81%E8%A6%83%27s+blog&url=https%3A%2F%2Fwww.cehui.ren%2Fposts%2Fmstn-xm-vba-code-bar-bas%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=MicroStation+XM+%E6%96%AD%E9%9D%A2%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F%E6%BA%90%E7%A0%81-%E6%A8%A1%E5%9D%97-BarCode+-+%E6%B5%8B%E9%87%8F%E8%80%81%E8%A6%83%27s+blog&u=https%3A%2F%2Fwww.cehui.ren%2Fposts%2Fmstn-xm-vba-code-bar-bas%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fwww.cehui.ren%2Fposts%2Fmstn-xm-vba-code-bar-bas%2F&text=MicroStation+XM+%E6%96%AD%E9%9D%A2%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F%E6%BA%90%E7%A0%81-%E6%A8%A1%E5%9D%97-BarCode+-+%E6%B5%8B%E9%87%8F%E8%80%81%E8%A6%83%27s+blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="http://service.weibo.com/share/share.php?title=MicroStation+XM+%E6%96%AD%E9%9D%A2%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F%E6%BA%90%E7%A0%81-%E6%A8%A1%E5%9D%97-BarCode+-+%E6%B5%8B%E9%87%8F%E8%80%81%E8%A6%83%27s+blog&url=https%3A%2F%2Fwww.cehui.ren%2Fposts%2Fmstn-xm-vba-code-bar-bas%2F" data-toggle="tooltip" data-placement="top" title="Weibo" target="_blank" rel="noopener" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" data-title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/autolisp-draw-3d-entity-code/">AutoLISP绘三维对象实体代码</a><li><a href="/posts/autolisp-layout-cass-points-draw-small-sphere/">AutoLISP源代码展CASS地形点生成三维小球体检查超欠挖</a><li><a href="/posts/mstn-accudraw-commands-hotkeys-list/">MicroStation精确绘图快捷键入命令的完整列表</a><li><a href="/posts/ord-plan-by-3D-element-smartline-create-alignment/">OpenRoads普通三维线段转化为Civil几何路线</a><li><a href="/posts/autocad-linework-commands/">AutoCAD编辑处理线构件LINEWORK相关命令</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/microstation/">MicroStation</a> <a class="post-tag" href="/tags/vba/">VBA</a> <a class="post-tag" href="/tags/%E4%BB%A3%E7%A0%81/">代码</a> <a class="post-tag" href="/tags/xm/">XM</a> <a class="post-tag" href="/tags/openroads/">OpenRoads</a> <a class="post-tag" href="/tags/key-in/">key-in</a> <a class="post-tag" href="/tags/%E6%96%B9%E9%87%8F/">方量</a> <a class="post-tag" href="/tags/civil3d/">Civil3D</a> <a class="post-tag" href="/tags/%E6%95%99%E7%A8%8B/">教程</a> <a class="post-tag" href="/tags/%E6%96%AD%E9%9D%A2/">断面</a></div></div></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/mstn-xm-vba-barcode/"><div class="card-body"> <em class="small" data-ts="1580918400" data-df="YYYY-MM-DD" > 2020-02-06 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>MicroStation VBA创建横断面图水平、高程标尺代码</h3><div class="text-muted small"><p> 这是本人2006年左右在重庆巴山水电站时在MicroStation XM环境下编的断面处理工具中绘横断面标尺的一段代码，在MicroStation CE环境下需要作小的修改才能正常运行。其中多数功能是相同的，可以借鉴。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 3...</p></div></div></a></div><div class="card"> <a href="/posts/mstn-xm-vba-code-menu-bas/"><div class="card-body"> <em class="small" data-ts="1204732800" data-df="YYYY-MM-DD" > 2008-03-06 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>MicroStation XM 断面处理程序源码-模块-menu</h3><div class="text-muted small"><p> MicroStation XM VBA编写的工程测量断面处理程序，与目前的MicroStation CE不兼容，需稍作调整方可在CE中运行。代码中大部分代码和功能、过程与目前高版一样，可以参考使用。 模块名：menu.bas Attribute VB_Name = &quot;menu&quot; Sub LoadPointsCom() loadPointsFrm.Show End Sub Su...</p></div></div></a></div><div class="card"> <a href="/posts/mstn-xm-vba-code-StartUpModel-bas/"><div class="card-body"> <em class="small" data-ts="1204819200" data-df="YYYY-MM-DD" > 2008-03-07 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>MicroStation XM 断面处理程序源码-模块-StartUpModel</h3><div class="text-muted small"><p> MicroStation XM VBA编写的工程测量断面处理程序，与目前的MicroStation CE不兼容，需稍作调整方可在CE中运行。代码中大部分代码和功能、过程与目前高版一样，可以参考使用。 模块名：StartUpModel.bas Attribute VB_Name = &quot;StartUpModel&quot; &#39;将读取CPU和硬盘序列号的Reg.DLL放在指定位置 Privat...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/mstn-xm-vba-code-CalString-bas/" class="btn btn-outline-primary" prompt="上一篇"><p>MicroStation XM 断面处理程序源码-模块-CalString</p></a> <a href="/posts/mstn-xm-vba-code-TrianglesFrm-form/" class="btn btn-outline-primary" prompt="下一篇"><p>MicroStation XM 断面处理程序源码-窗体-TrianglesFrm</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/qd_xyz">QinDong</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/microstation/">MicroStation</a> <a class="post-tag" href="/tags/vba/">VBA</a> <a class="post-tag" href="/tags/%E4%BB%A3%E7%A0%81/">代码</a> <a class="post-tag" href="/tags/xm/">XM</a> <a class="post-tag" href="/tags/openroads/">OpenRoads</a> <a class="post-tag" href="/tags/key-in/">key-in</a> <a class="post-tag" href="/tags/%E6%96%B9%E9%87%8F/">方量</a> <a class="post-tag" href="/tags/civil3d/">Civil3D</a> <a class="post-tag" href="/tags/%E6%95%99%E7%A8%8B/">教程</a> <a class="post-tag" href="/tags/%E6%96%AD%E9%9D%A2/">断面</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">发现新版本的内容。</p><button type="button" class="btn btn-primary" aria-label="Update"> 更新 </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/zh.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
